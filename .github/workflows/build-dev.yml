name: Deploy application
on:
  push:
    branches:
      - main

permissions:
  id-token: write
  contents: read

jobs:
  set-variables:
    name: "Set Environment"
    runs-on: ubuntu-latest
    outputs:
      mayus_env: ${{ steps.MayusEnv.outputs.uppercase }}
      lower_env: ${{ steps.MayusEnv.outputs.lowercase }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis
      - id: MayusEnv
        uses: ASzc/change-string-case-action@v6
        with:
          string: 'dev'
  deploy:
    name: Deploy dev AWS
    runs-on: ubuntu-latest
    needs: [set-variables]
    env:
      APP_NAME: ${{ vars.APPNAME }}
      ENVIRONMENT: ${{ needs.set-variables.outputs.lower_env }}
      DEPLOYMENT_BUCKET: ${{ secrets[format('{0}_DEPLOYMENT_BUCKET', needs.set-variables.outputs.mayus_env)] }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis
      - uses: actions/setup-python@v3
      - uses: aws-actions/setup-sam@v2
      - name: Configure AWS Credentials Role
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets[format('{0}_AWS_ROLE_TO_ASSUME', needs.set-variables.outputs.mayus_env)] }}
          role-session-name: networking-infra-deploy
          aws-region: ${{ secrets[format('{0}_AWS_REGION', needs.set-variables.outputs.mayus_env)] }}
      - name: Copying psycopg libraries
        run: aws s3 cp psycopg2.zip s3://$DEPLOYMENT_BUCKET/deploys/libs/psycopg2.zip
      - name:  Construyendo proyecto SAM para ambiente dev
        run: sam build --use-container --build-image ${{ vars.CONTAINER_BUILDER }}
      - name: Deployment stage
        run: sam deploy --stack-name $ENVIRONMENT-$APP_NAME-app-sam-stack --s3-bucket $DEPLOYMENT_BUCKET --s3-prefix $APP_NAME/deploys/app/ --parameter-overrides Environment=$ENVIRONMENT AppName=$APP_NAME Stage=$ENVIRONMENT --capabilities CAPABILITY_IAM CAPABILITY_AUTO_EXPAND


